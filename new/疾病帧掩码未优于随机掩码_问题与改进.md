# 疾病帧掩码未优于随机掩码：可能原因与改进

## 现象

在 ADReSS 上，`mask_strategy=pathology`（疾病帧智能掩码）与 `mask_strategy=random`（随机掩码）的 **best_val_acc 均为 72.73%**，未体现“针对病理片段掩码”的收益。

---

## 可能原因

### 1. 掩码比例过大（mask_prob=0.65）

- 原先默认掩掉约 **65%** 的波形，训练时模型几乎总在看“大半被抹掉”的语音。
- 在这种强度下，“**掩哪里**”（病理帧 vs 随机）的差异容易被稀释，两种策略的表现容易趋同。
- **改进**：降低 `mask_prob`（例如 **0.35**），让“掩码位置”的差异更明显。脚本已默认改为 0.35。

### 2. 病理帧检测阈值偏低（threshold_percentile=75）

- 75 表示把病理得分最高的 **25%** 的帧标为“病理帧”，比例较高。
- 若这些帧在时间上较分散，智能掩码和“随机抹掉 65%”在空间分布上可能差别不大。
- **改进**：提高阈值，只掩**最像病理**的帧（例如 **85 或 90**），使病理掩码更集中、更有针对性。脚本已默认改为 85。

### 3. 病理帧占比与随机补足（pathology_ratio=0.8）

- 80% 掩码预算给病理帧，20% 随机补足；若检测到的病理帧很少，实际效果会接近“随机掩码”。
- **改进**：可尝试 **pathology_ratio=1.0**（仅掩病理帧），或配合更高 `pathology_threshold` 使用。脚本已默认改为 0.9。

### 4. 数据集/语言不匹配

- 病理检测器（节奏不规则、停顿、音调单调等）最初在 **NCMMSC（中文）** 上使用，**ADReSS 为英文**，声学分布可能不同。
- 在 ADReSS 上“病理帧”可能既不集中、也不稳定，导致智能掩码与随机掩码在统计上相似。
- **改进**：在 ADReSS 上做一次特征分布统计，按该分布重设 `pathology_threshold`；或接受“当前检测器在英文上区分度有限”，优先用 1–3 的调参观察趋势。

### 5. 验证集过小（22 人）

- 仅 22 个验证样本，准确率方差大，**72.73% vs 72.73%** 无法说明二者真无差异。
- **改进**：多 seed 跑几轮（如 3–5），看 pathology 相对 random 的 mean±std；若有官方 test set，在 test 上再比一次更稳妥。

### 6. 全程强增强、无“干净”样本

- 若每条训练样本都被强掩码，模型从未见过较完整的语音，可能损害利用正常片段的能力。
- **改进**：用 **aug_prob<1**（如 0.7），使部分样本保留原始波形，形成“干净 + 增强”混合训练。脚本已支持 `--aug_prob`。

---

## 已做的脚本改动（可直接用）

在 `long_wavlm_disease_mask_experiment.py` 中新增/修改了以下参数（仅当 `mask_strategy` 为 pathology/random 时生效）：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--mask_prob` | **0.35** | 掩码比例，比原先 0.65 更轻，便于体现“位置”差异 |
| `--pathology_ratio` | **0.9** | 智能掩码中病理帧占比，0.9 表示 90% 掩码预算给病理帧 |
| `--pathology_threshold` | **85.0** | 病理帧检测百分位阈值，越高越只掩“最像病理”的帧 |
| `--aug_prob` | **1.0** | 每条样本应用掩码的概率；<1 时部分样本用原始波形 |

**推荐先跑一组对比**（保持 random 与 pathology 使用相同 mask_prob，便于公平比较）：

```bash
cd /home/sunqi/pd

# 疾病帧掩码（新默认：更轻、更针对病理）
python new/long_wavlm_disease_mask_experiment.py \
  --data_root /mnt/lv2/data/ad/ADReSS \
  --mask_strategy pathology

# 随机掩码（同样 mask_prob=0.35，公平对照）
python new/long_wavlm_disease_mask_experiment.py \
  --data_root /mnt/lv2/data/ad/ADReSS \
  --mask_strategy random
```

若要**混合增强**（约 70% 样本做掩码、30% 原始）：

```bash
python new/long_wavlm_disease_mask_experiment.py \
  --data_root /mnt/lv2/data/ad/ADReSS \
  --mask_strategy pathology \
  --aug_prob 0.7
```

若要**更激进地只掩病理**（仅病理帧、阈值 90）：

```bash
python new/long_wavlm_disease_mask_experiment.py \
  --data_root /mnt/lv2/data/ad/ADReSS \
  --mask_strategy pathology \
  --mask_prob 0.35 \
  --pathology_ratio 1.0 \
  --pathology_threshold 90
```

---

## 小结

- **问题**：疾病帧掩码未优于随机掩码，可能与**掩码过强、病理帧定义过宽、数据/语言不匹配、验证集太小**等有关。
- **改动**：默认降低 `mask_prob`、提高 `pathology_threshold`、提高 `pathology_ratio`，并支持 `aug_prob` 做混合增强。
- **建议**：用新默认或上述推荐命令重跑 pathology vs random，并做多 seed 或官方 test 评估，再下结论。
